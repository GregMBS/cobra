<?php
set_time_limit(300);

/**
 *  outputCSV creates a line of CSV and outputs it to browser    
 */
function outputCSV($array)
{
    $fp = fopen('php://output', 'w'); // this file actual writes to php output
    fputcsv($fp, $array);
    fclose($fp);
}

/**
 *  getCSV creates a line of CSV and returns it. 
 */
function getCSV($array)
{
    ob_start(); // buffer the output ...
    outputCSV($array);
    return ob_get_clean(); // ... then return it as a string!
}
//require_once 'Spreadsheet/Excel/Writer.php';
include('admin_hdr_2.php');
while ($answercheck = mysql_fetch_row($resultcheck)) {
    if ($answercheck[0] != 1) {
        die($capt.$ticket);
    } else {

        function MesNom($n)
        {
            $timestamp = mktime(0, 0, 0, $n, 1, 2005);

            return date("M", $timestamp);
        }
        $querymain = "SELECT id_cuenta,numero_de_cuenta,nombre_deudor,resumen.cliente,
    substring_index(status_de_credito,'-',1) as segmento,
    if (status_de_credito regexp '-',substring_index(status_de_credito,'-',-1),'') as disposicion,
    producto,subproducto,
    saldo_total,d1.queue,saldo_descuento_1,saldo_descuento_2,
    domicilio_deudor,colonia_deudor,ciudad_deudor, estado_deudor,cp_deudor,
    ejecutivo_asignado_call_center, ejecutivo_asignado_domiciliario,
count(historia.auto) as gestiones
    from resumen 
left join dictamenes d1 on status_aarsa=d1.dictamen
left join historia on id_cuenta=c_cont
where numero_de_cuenta in ('0010182545',
'4097956238',
'490T125473',
'364BK53846',
'126YC61014',
'584YF29629',
'147YI27865',
'090YM08918',
'602YF34405',
'392YD07481',
'602YE79079',
'599YJ49149',
'599YK65924',
'126YD04171',
'017YL91197',
'079YO53367',
'602YF44412',
'599YO09912',
'001AJ75326',
'599YK82230',
'001AJ77083',
'001AJ66145',
'001AJ64699',
'001AJ72669',
'050YE04965',
'140YM00843',
'001FD01415',
'602YN62594',
'001AJ66431',
'565YP23050',
'001AJ66164',
'001AS66039',
'001AJ79290',
'001AJ79621',
'001AJ76758',
'165AF59213',
'001AJ74589',
'001AJ63433',
'001AF59331',
'001AJ65213',
'064AF37671',
'602YK89344',
'001AX10440',
'001AJ73611',
'079YP12774',
'247CJ51642',
'602YM84831',
'001AJ66246',
'001DX32432',
'001YT57793',
'001AJ59707',
'001AB36536',
'802WG55267',
'184YW62591',
'001VJ44415',
'001YW47710',
'0010191325',
'600YP62657',
'539YP14485',
'001RY45897',
'001YT60687',
'001VD44543',
'001VD37682',
'001YP57275',
'179CC29558',
'001Q508102',
'165YZ95418',
'001RY42168',
'001YW48015',
'001YT56208',
'0011922080',
'147YT57774',
'147YT53549',
'001H517171',
'001VD37475',
'064YP50388',
'126YD03848',
'001VD39672',
'490YF66203',
'001VD46146',
'126YT51666',
'001YD58134',
'001VD47780',
'001XP22687',
'096RY45836',
'188RY41134',
'184VD64550',
'001R542388',
'001DH10733',
'056VD26735',
'001VP56593',
'001VD57540',
'042XT49001',
'001YP14733',
'001VD24484',
'001YD55266',
'042VT19233',
'056QE08799',
'050PI08505',
'001XP30406',
'096VD73135',
'001BI44421',
'001VD64477',
'001VD27609',
'802YT55385',
'001AJ82855',
'001VD59726',
'0805945678',
'001VD28190',
'001SX08700',
'001RY42160',
'001TT07131',
'539YP40800',
'056VD26832',
'165AS70651',
'001UU44284',
'001WD29512',
'1658190072',
'561AU02274',
'001VZ48101',
'001AR57779',
'001YK31674',
'001M152018',
'147YK19801',
'064YP72660',
'539XP22675',
'001VP65560',
'0012328086',
'001QY78007',
'001QE09210',
'026VW05212',
'147YK09609',
'001YK25038',
'001RY42136',
'001Q571694',
'001BV14121',
'001VP60287',
'001VT15659',
'080YK15096',
'001SP05715',
'001VD64444',
'004TT05634',
'001YP70315',
'165XP36800',
'147YP11030',
'0010288958',
'392VD62138',
'064VG01106',
'001M568075',
'080VD29841',
'001BM37545',
'165VP59039',
'561XM22791',
'247H168296',
'165WD34754',
'001VG97095',
'080VD69072',
'090VW98553',
'042RY45138',
'096YP54867',
'223QW05771',
'001VG05482',
'064YP20752',
'001YK10476',
'001YT46363',
'090YD53050',
'165YW60247',
'001DK68835',
'001YK22909',
'001T488052',
'064XP30719',
'001AJ63668',
'064PI09732',
'147XT43733',
'802VW07149',
'0016372314',
'165YT59051',
'001VT15414',
'001XT45695',
'001VJ43648',
'001YP68727',
'056VJ43543',
'208YP82265',
'208A493816',
'539YW56302',
'001YK12452',
'004VT16151',
'0010187835',
'001AI14032',
'165QW04480',
'0010284912',
'0010243814',
'096VW09317',
'001VZ60370',
'1655360759',
'001XL61322',
'001YP63956',
'165SP07123',
'001YP32148',
'056RY43564',
'1043749240',
'802VZ61496',
'001VZ60930',
'001UU42773',
'001YD61832',
'392PI08050',
'001G824128',
'802VP53633',
'208YP81400',
'184SX08558',
'001VD72971',
'001SP10491',
'0010280827',
'001VJ49744',
'001VG07776',
'001YK20636',
'001SX09821',
'800VW99805',
'001XT31382',
'001X908716',
'539VD65162',
'042SP06736',
'001VD41150',
'001YT48367',
'090VD40101',
'001TT06844',
'001WD31291',
'096VP53360',
'165YP82418',
'188QE06301',
'001PI08593',
'001VD24294',
'001KF61827',
'001SP06291',
'904YT59943',
'001S000825',
'539YK24488',
'0010117052',
'532SP07072',
'001UU45738',
'001VW02844',
'001YD66264',
'001VD60943',
'001SX10515',
'165VG03935',
'001CM18211',
'001VP52913',
'001QW04885',
'001YK28990',
'001VD63682',
'165SX10939',
'001SP06410',
'042WD26250',
'001SX10934',
'042VD41338',
'001YK34786',
'001VD59210',
'001VD66449',
'001VG07353',
'001SX08977',
'001TT02683',
'001T042662',
'001SP04346',
'001TT04035',
'539WG63808',
'001YD69315',
'001YP82655',
'539VP54508',
'0647334463',
'001VP63670',
'001XP32555',
'184BE15287',
'001TT02719',
'189XM23944',
'001SP10515',
'042QE06905',
'223RY45299',
'001YK16468',
'223VP63018',
'004RY42926',
'001C449252',
'001K343581',
'165R220766',
'802YP79232',
'001TT03186',
'001OF86820',
'001VP58292',
'090VD39183',
'004VG02682',
'064YW70336',
'0010092488',
'147QW08350',
'001WG55724',
'001YK34184',
'001YK32072',
'064TT06047',
'064YD70226',
'001VW07109',
'001SX16223',
'001U694605',
'056RY43560',
'247H217623',
'056YK22327',
'165QW03990',
'064QW06519',
'001SX13186',
'001VP59192',
'001YP72824',
'001YP77457',
'600OF87838',
'001YT55875',
'1083947047',
'001YK14997',
'165XP20399',
'532VD36552',
'001YK24751',
'001C085623',
'001SP07153',
'165QW05212',
'001G637467',
'001RY42843',
'001UU46878',
'165VT15860',
'001YP59598',
'904SP10671',
'802VT20018',
'001VD67627',
'208VZ51250',
'165SX12972',
'001VD40187',
'165VD31627',
'090VD24252',
'0013522694',
'539XL59472',
'539YP39672',
'001UU39834',
'001XP41856',
'001YP81718',
'001QS09115',
'090YW49236',
'001CE62012',
'001VD25453',
'247O926341',
'188UU47135',
'802VD53405',
'147YK11053',
'001VD58983',
'147LM06739',
'080YP58085',
'184VZ54224',
'001YP62511',
'184VD47157',
'603VP66709',
'001XT46360',
'147VD68241',
'001S275362',
'165YT45938',
'056VW11157',
'165VZ53571',
'001K582488',
'001VG07849',
'001RY43481',
'001VD34157',
'001XT41791',
'001VD29307',
'001D760004',
'064XT31442',
'147VZ53291',
'001VW00022',
'001QE07677',
'165YK13056',
'096VD55517',
'001VG97949',
'001XP23916',
'001VG06678',
'184YP54399',
'001VT16900',
'165OF85039',
'001YP58204',
'001YP52523',
'0042705149',
'600QE09497',
'080PI08361',
'064VZ54082',
'001TT04127',
'001VD37950',
'001VZ50771',
'0010236525',
'001QE17452',
'001VD54156',
'184RY42497',
'001VW00704',
'001VT21252',
'042XP41501',
'001VP63105',
'561UU49180',
'0170007591',
'001YP55825',
'001QW04153',
'165VD60925',
'080SP07031',
'001VD54676',
'001C328675',
'001YD68556',
'001BA38191',
'001XP20890',
'042SX10299',
'126SX14506',
'1794948974',
'001PI08536',
'001TT01496',
'001XP32466',
'064PI07424',
'004XT46232',
'090YT60382',
'561XP32722',
'188QW06949',
'001R128320',
'001VW03231',
'802VT20206',
'539VD37708',
'223VW11705',
'001VD44124',
'090PI06158',
'001XM17891',
'539XP44603',
'004V801593',
'001VJ43461',
'042RY42284',
'001L329863',
'001VD30028',
'184VD42984',
'001YD55218',
'001YP76654',
'064YT61249',
'001YP69046',
'096VW01313',
'001XP19023',
'001AF50417',
'001VT21519',
'001UU43767',
'001VW02545',
'001SP09856',
'001SP09301',
'080XT46572',
'001VD50538',
'364XP28402',
'056YK17871',
'147YK25522',
'064VD54749',
'001YP74746',
'064XT38315',
'090WD33347',
'188VD59619',
'001PI06537',
'001YP83823',
'165VD32157',
'064OF88921',
'001YK34125',
'539BY35114',
'802QW06110',
'080UU42318',
'001VD48246',
'001SP04816',
'001VG01826',
'802XT51619',
'0010176864',
'001VD39209',
'001VP55413',
'184VG04399',
'0015683249',
'165N203041',
'001AN89484',
'208H971724',
'080Z693648',
'001YW63535',
'001VP67254',
'001YK31708',
'001SX09775',
'001QW04649',
'165XP39609',
'001YP29763',
'802WD32848',
'064XM17675',
'001SX13351',
'001YP50119',
'001YP79742',
'001RY42092',
'064XT30766',
'096TT01659',
'802VD70381',
'001RY45095',
'208PI08156',
'001VW06538',
'056H132270',
'001VG99384',
'001J046455',
'064TT06176',
'001VG10213',
'001SP07989',
'904VW10991',
'001CL36584',
'064YW58561',
'0010152532',
'165YZ91170',
'001QW03599',
'001YK33336',
'001YP47282',
'001YK34157',
'126BO76877',
'147XT44498',
'080SP06026',
'056Y246633',
'001XP26778',
'001VJ49358',
'1044766612',
'001YK35142',
'004YP58007',
'001V453061',
'001YP34515',
'001XT43891',
'001VD46154',
'001YP49841',
'539T578778',
'165YD58124',
'490G768831',
'042XP38976',
'001VZ50399',
'001I111960',
'056YK17908',
'184VZ53909',
'042QW07736',
'001YP53828',
'0010110455',
'001VD66689',
'080TT02493',
'539WG48530',
'628YP58907',
'0010239262',
'001YW51291',
'001YD68230',
'392RY44285',
'147XP32012',
'001XP30227',
'080YD63966',
'001SP08960',
'001SX13861',
'001XP32736',
'802YW57656',
'147PI06213',
'223VT21268',
'165XP18811',
'208YP74404',
'001VP53747',
'001XP35846',
'001PI07826',
'001O673473',
'001Z720284',
'165SP07089',
'064UU45925',
'001VD51147',
'001VP61640',
'001AJ79707',
'096PI09759',
'001WD32398',
'532YP57723',
'001DB97678',
'416VW08478',
'001VD38803',
'001XT54262',
'001YP16360',
'165WG58932',
'001YK14306',
'001C924005',
'001PI09647',
'184UU45833',
'001SX09607',
'001XP43925',
'001UU45817',
'208VW02700',
'223XL90775',
'147YW61611',
'001VD27962',
'001SP05199',
'001Q098685',
'001XP23221',
'090RY41848',
'001YP37016',
'223XP44477',
'001VW08227',
'001XT53214',
'001VW11224',
'004VD45271',
'001PI06864',
'001VG12095',
'001XT47440',
'001VD30239',
'001VD58660',
'001U399065',
'001XT42479',
'080VD55757',
'001UU39703',
'165TT02697',
'814VG99166',
'042YP82786',
'001VD68106',
'409VD43119',
'001XP32801',
'001VJ43278',
'001XP23461',
'802YW60179',
'090VZ47880',
'001S697613',
'001SP04337',
'001SX08799',
'001AF49762',
'184VD51618',
'0170009176',
'001F320859',
'2236085619',
'208XT34121',
'001VP65815',
'001VD32625',
'001QW06942',
'001VD33285',
'004VP59765',
'001AJ61847',
'001YD60355',
'001VD57368',
'001VD57797',
'001YK23384',
'147PI07557',
'0015636870',
'184YP78481',
'364VW03913',
'042VD24107',
'474TT06411',
'001UU44369',
'0010245516',
'147YK10547',
'001UU47227',
'184QE07585',
'184XM25147',
'802YW65439',
'001YD65272',
'001XP30289',
'001VD49764',
'001XT47476',
'001VZ58437',
'001YD66130',
'539VW09673',
'001VW00912',
'090LM03092',
'080XP45604',
'001XT52407',
'001VD45757',
'001TT06326',
'001XP27555',
'0010270993',
'042YK26729',
'001YW53499',
'001VW07219',
'096QW08548',
'001AJ80657',
'042BW94496',
'001VD52727',
'001SP04960',
'001VD54928',
'001YK26159',
'147YK11998',
'001XP34666',
'165YP44964',
'179BP86709',
'001YK15179',
'126OF87750',
'311VP63118',
'001VG95646',
'0010158419',
'090QW03679',
'802WG61283',
'001XP30419',
'001UU41185',
'188YD51848',
'001VW08376',
'223VT16722',
'001YP49462',
'001TT07359',
'165YP25108',
'090PI06190',
'809T935813',
'147YT46826',
'004XL52749',
'001YK10020',
'001YK29718',
'165RY42535',
'147XT51757',
'042XP41566',
'001YP50588',
'001E867036',
'140AZ03455',
'532XP36303',
'147UU42786',
'001XP30158',
'001YD68867',
'208XP25302',
'474XP33512',
'001VD48931',
'001RY45054',
'064QE10127',
'165VW05708',
'001VD38098',
'001R502375',
'001VD25366',
'001UU37283',
'001PI07379',
'001XP41723',
'001VD67367',
'184SX14964',
'042VD24221',
'184XP43238',
'207DH10719',
'208WD30310',
'001VD69875',
'001WD35878',
'490BM45165',
'042YK27485',
'001TT01922',
'2470287453',
'165YT52521',
'001QW04441',
'208VD52923',
'001YT56083',
'001XP35773',
'001VW05777',
'001YP47041',
'539VG00178',
'001VP57674',
'565VZ59610',
'247CK24051',
'539VD30913',
'001VJ42023',
'147TT03341',
'001YK23606',
'539DB77799',
'561VD31280',
'184VP54573',
'126XP41663',
'001SP10132',
'001VD66379',
'080YP76267',
'001E233190',
'539VD64864',
'001SP07803',
'165XP32491',
'184XL68169',
'001QW04711',
'026XP35008',
'904YK13415',
'561UU39061',
'001XM19398',
'001XP40137',
'001YK24314',
'001XL59536',
'0010145603',
'147YP09211',
'165XT44077',
'001VD69735',
'064YW49721',
'001Y139125',
'001VD29060',
'001VG07294',
'001YD52461',
'001DS08923',
'001YD56087',
'539XM21093',
'165VZ49745',
'001UU46879',
'001XP41711',
'802VT19869',
'539YP38952',
'147YK12179',
'001YD69887',
'0170009424',
'001VG07367',
'001XP29019',
'001VW08952',
'001R958923',
'001WG53378',
'001VW04795',
'001VD29997',
'080VP58336',
'474YK32006',
'096VW99414',
'096TT01469',
'001XT52064',
'188B201924',
'188YP16262',
'0010263304',
'004VD51357',
'064YP85045',
'004VD45069',
'001YK15134',
'001UU43964',
'188QE06227',
'001TT02601',
'165WD30120',
'096SX14619',
'223YP16694',
'189VD51384',
'001UU40530',
'001YD68408',
'001YD55975',
'001CG62476',
'001SX17460',
'001XP40645',
'001WD24712',
'001VZ55867',
'001XP44283',
'042VW07533',
'179G140028',
'539VD28525',
'001YK29957',
'001VW11965',
'001VD44851',
'165XT34168',
'001YK20257',
'001YP50178',
'004VD44299',
'001YP40462',
'001YP81074',
'096UU36408',
'064YP75565',
'001SX09843',
'001QE08077',
'223VW11711',
'001VD58830',
'208UU41870',
'001YK12002',
'080XP45491',
'539XT44224',
'208XP27387',
'001J505857',
'1043666053',
'001VD25743',
'001XP21417',
'165YP71455',
'001QW06618',
'001YD63284',
'001UU44399',
'001TT08392',
'001YT50617',
'001SP07518',
'0010099495',
'001TT02595',
'090VP54366',
'001XP32023',
'001SX09769',
'001XP35598',
'001YD59562',
'586TT05871',
'001N593617',
'001VD33473',
'001VW09252',
'0044731578',
'090VP53204',
'147YK27196',
'802XT37568',
'490C160316',
'539VG03588',
'001VD71939',
'001VW07862',
'001YK12729',
'001YD65583',
'539VD64820',
'001WD32423',
'017FC10394',
'001XP43287',
'004VD51366',
'001YK29518',
'042PI06825',
'001TT02415',
'001VD63488',
'4165969371',
'165WD31920',
'001VD48162',
'096QW03071',
'001SP04857',
'409UU39628',
'001YD64612',
'090YP22356',
'0174336191',
'147YZ99923',
'184T681528',
'001SP05872',
'090WD30688',
'064YW54083',
'001YD59335',
'491RY43936',
'001QE08522',
'001VD26652',
'096SP10999',
'104S489554',
'001YD58376',
'090N690306',
'001UU42019',
'042VD29272',
'184VD33676',
'208XP27446',
'188VG07131',
'223TT05912',
'001YT56892',
'001SX16289',
'004XP29740',
'184QE09732',
'147YK13321',
'001V270910',
'042QW04965',
'064YZ87539',
'001XP39540',
'080RY45811',
'019VD39253',
'042YD64344',
'004VD37281',
'001VD28038',
'080VW07033',
'0010254217',
'080UU42117',
'104V966776',
'001XT37029',
'802VT17170',
'001XP27949',
'001BG02788',
'490BR73897',
'001SP10294',
'565SX14794',
'165XP25101',
'165VZ53737',
'001VP59710',
'042YP80065',
'001VG09483',
'188VD35107',
'539SP07652',
'904XP43653',
'001L530542',
'165YP14567',
'0010099301',
'001TT01562',
'001QW04426',
'802XP33399',
'165UU38109',
'001VW08845',
'165XP28980',
'165OF86795',
'064XL59161',
'802XP39586',
'0044364136',
'001XP36116',
'001CP52941',
'0010058321',
'001RY41471',
'001XP39433',
'184VD27356',
'147VG02758',
'311VD47040',
'001VZ53634',
'165XP41626',
'490Z055766',
'184YK30609',
'096YP51380',
'001YD52090',
'090YK31147',
'042XP38929',
'904XP43893',
'416XP31730',
'001YP67217',
'001VZ48028',
'001C081774',
'042VP62956',
'001J264781',
'184SX15011',
'001XP28664',
'090XP37681',
'0010248910',
'056YP42436',
'0016449964',
'0010222955',
'0645942047',
'147VG98339',
'802XP27675',
'147QW05588',
'603RY43182',
'0010157656',
'001UU46688',
'001T966408',
'184XP23873',
'096VG96738',
'090VW98853',
'001QS09059',
'096VD24204',
'064UU45936',
'001XP41720',
'147XT80220',
'0567399099',
'490X491681',
'096VG06198',
'090XP20921',
'026VD70616',
'532VW01491',
'565XH03861',
'042XH10301',
'147VD44776',
'184XP30485',
'056YW48213')
group by id_cuenta
ORDER BY cliente,status_de_credito,queue,numero_de_cuenta
    ;";
//if ($capt=='gmbs') {die(htmlentities($querymain));}
        $result    = mysql_query($querymain) or die(mysql_error());
// Creating a workbook
//$workbook = new Spreadsheet_Excel_Writer();

        $filename = "Query_de_inventario_".trim(date('ymd')).".csv";
// sending HTTP headers
//$workbook->send($filename);
        header('Content-type: application/xls');
        header('Content-Disposition: attachment; filename="'.$filename.'"');

// Creating a worksheet
//$worksheet =& $workbook->addWorksheet('Reporte CS');
//$worksheet->setInputEncoding('ISO-8859-1');


        $ii           = 0;
        $numberfields = mysql_num_fields($result);
        $afield       = array();
        for ($i = 0; $i < $numberfields; $i++) {
            $var = mysql_field_name($result, $i);
            if ($var == 'numero_de_cuenta') {
                $nccol = $i;
            }
//	$worksheet->write(0, $i, $var);
            $afield[] = $var;
        }
        echo getcsv($afield);
        if (substr(getcsv($afield), -1) != "\n") {
            echo "\n";
        }
        $ii++;

        while ($row = mysql_fetch_row($result)) {
            $arow = array();
//	$row[$nccol]="'".$row[$nccol];
            for ($j = 0; $j < $numberfields; $j++) {
                $arow[] = $row[$j];
            }
            echo getcsv($arow);
            if (substr(getcsv($arow), -1) != "\n") {
                echo "\n";
            }
            $ii++;
        }
//$workbook->close();
    }
}